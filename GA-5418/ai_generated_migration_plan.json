[
    {
        "step": "create_dataiku_project",
        "parameters": {
            "project_key": "CUSTOMER360_ANALYSIS",
            "name": "Customer 360 Data Integration",
            "description": "Migrating Alteryx workflows for comprehensive customer data analysis."
        }
    },
    {
        "step": "create_s3_file_datasets",
        "parameters": {
            "project_key": "CUSTOMER360_ANALYSIS",
            "connection_name": "Customer360Connection",
            "bucket_name": "dataeconomy-ohio",
            "base_path": "ApplicationsData/JNJDataverse/Customer360/",
            "file_names": [
                "aiml_insights.xlsx",
                "claims.csv",
                "demographics.xlsx",
                "policy.xlsx",
                "scores.xlsx"
            ]
        }
    },
    {
        "step": "create_prepare_recipe",
        "parameters": {
            "project_key": "CUSTOMER360_ANALYSIS",
            "recipe_name": "select_demographics_fields",
            "input_dataset": "demographics",
            "output_dataset": "demographics_selected",
            "actions": [
                {
                    "action": "SelectColumns",
                    "params": {
                        "keep": [
                            "Customer_ID",
                            "Customer_Name",
                            "Email",
                            "Phone_Number",
                            "Address",
                            "City",
                            "State",
                            "Postal_Code",
                            "Date_of_Birth",
                            "Gender",
                            "Marital_Status",
                            "Occupation",
                            "Income_Level",
                            "Customer_Segment"
                        ]
                    }
                }
            ]
        }
    },
    {
        "step": "create_prepare_recipe",
        "parameters": {
            "project_key": "CUSTOMER360_ANALYSIS",
            "recipe_name": "select_claims_fields",
            "input_dataset": "claims",
            "output_dataset": "claims_selected",
            "actions": [
                {
                    "action": "SelectColumns",
                    "params": {
                        "keep": [
                            "Claim_ID",
                            "Policy_ID",
                            "Claim_Date",
                            "Claim_Type",
                            "Claim_Status",
                            "Claim_Amount",
                            "Claim_Payout"
                        ]
                    }
                }
            ]
        }
    },
    {
        "step": "create_prepare_recipe",
        "parameters": {
            "project_key": "CUSTOMER360_ANALYSIS",
            "recipe_name": "select_policy_fields",
            "input_dataset": "policy",
            "output_dataset": "policy_selected",
            "actions": [
                {
                    "action": "SelectColumns",
                    "params": {
                        "keep": [
                            "Policy_ID",
                            "Customer_ID",
                            "policy_type",
                            "policy_status",
                            "policy_start_date",
                            "policy_end_date",
                            "policy_term",
                            "policy_premium",
                            "total_premium_paid",
                            "renewal_status",
                            "policy_addons"
                        ]
                    }
                }
            ]
        }
    },
    {
        "step": "create_join_recipe",
        "parameters": {
            "project_key": "CUSTOMER360_ANALYSIS",
            "recipe_name": "join_demographics_policy",
            "left_input": "demographics_selected",
            "right_input": "policy_selected",
            "output_dataset": "demographics_policy_joined",
            "join_type": "INNER",
            "join_conditions": [
                {
                    "left_column": "Customer_ID",
                    "right_column": "Customer_ID",
                    "operator": "EQ"
                }
            ]
        }
    },
    {
        "step": "create_join_recipe",
        "parameters": {
            "project_key": "CUSTOMER360_ANALYSIS",
            "recipe_name": "join_demographics_policy_claims",
            "left_input": "demographics_policy_joined",
            "right_input": "claims_selected",
            "output_dataset": "demographics_policy_claims_joined",
            "join_type": "INNER",
            "join_conditions": [
                {
                    "left_column": "Policy_ID",
                    "right_column": "Policy_ID",
                    "operator": "EQ"
                }
            ]
        }
    },
    {
        "step": "run_aggregation_flow",
        "parameters": {
            "project_key": "CUSTOMER360_ANALYSIS",
            "input_dataset": "demographics_policy_claims_joined",
            "output_dataset": "aggregated_data",
            "group_by": [
                "Customer_ID"
            ],
            "aggregations": [
                {
                    "column": "Claim_ID",
                    "aggregation_type": "count",
                    "output_column": "Total_Claims"
                },
                {
                    "column": "Policy_ID",
                    "aggregation_type": "count",
                    "output_column": "Policy_Count"
                },
                {
                    "column": "Claim_Date",
                    "aggregation_type": "max",
                    "output_column": "Recent_Claim_Date"
                },
                {
                    "column": "Claim_Amount",
                    "aggregation_type": "avg",
                    "output_column": "Average_Claim_Amount"
                }
            ]
        }
    },
    {
        "step": "create_join_recipe",
        "parameters": {
            "project_key": "CUSTOMER360_ANALYSIS",
            "recipe_name": "join_aggregated_customer_data",
            "left_input": "aggregated_data",
            "right_input": "demographics_selected",
            "output_dataset": "customer_data_joined",
            "join_type": "INNER",
            "join_conditions": [
                {
                    "left_column": "Customer_ID",
                    "right_column": "Customer_ID",
                    "operator": "EQ"
                }
            ]
        }
    },
    {
        "step": "generate_and_create_dataiku_code_recipe",
        "parameters": {
            "project_key": "CUSTOMER360_ANALYSIS",
            "input_dataset_name": "customer_data_joined",
            "output_dataset_name": "final_calculated_data",
            "recipe_name": "custom_calculations",
            "run_recipe": true,
            "transformations": [
                {
                    "action": "add_column",
                    "parameters": {
                        "column_name": "Age",
                        "formula": "DateTimeDiff(DateTimeToday(), Date_of_Birth, 'years')"
                    }
                },
                {
                    "action": "add_column",
                    "parameters": {
                        "column_name": "Claim_To_Premium_Ratio",
                        "formula": "if(total_premium_paid != 0, Claim_Amount / total_premium_paid, 0)"
                    }
                },
                {
                    "action": "add_column",
                    "parameters": {
                        "column_name": "Claims_Per_Policy",
                        "formula": "if(Policy_Count != 0, Total_Claims / Policy_Count, 0)"
                    }
                },
                {
                    "action": "add_column",
                    "parameters": {
                        "column_name": "Retention_Rate",
                        "formula": "0.85"
                    }
                },
                {
                    "action": "add_column",
                    "parameters": {
                        "column_name": "Cross_Sell_Opportunities",
                        "formula": "'Multi-Policy Discount, Home Coverage Add-on'"
                    }
                },
                {
                    "action": "add_column",
                    "parameters": {
                        "column_name": "Upsell_Potential",
                        "formula": "'Premium Vehicle Coverage'"
                    }
                }
            ]
        }
    },
    {
        "step": "create_prepare_recipe",
        "parameters": {
            "project_key": "CUSTOMER360_ANALYSIS",
            "recipe_name": "select_aiml_insights_fields",
            "input_dataset": "aiml_insights",
            "output_dataset": "aiml_insights_selected",
            "actions": [
                {
                    "action": "SelectColumns",
                    "params": {
                        "keep": [
                            "Customer_ID",
                            "Churn_Probability",
                            "Next_Best_Offer",
                            "Claims_Fraud_Probability",
                            "Revenue_Potential"
                        ]
                    }
                }
            ]
        }
    },
    {
        "step": "create_prepare_recipe",
        "parameters": {
            "project_key": "CUSTOMER360_ANALYSIS",
            "recipe_name": "select_scores_fields",
            "input_dataset": "scores",
            "output_dataset": "scores_selected",
            "actions": [
                {
                    "action": "SelectColumns",
                    "params": {
                        "keep": [
                            "Customer_ID",
                            "Credit_Score",
                            "Fraud_Score",
                            "Customer_Risk_Score"
                        ]
                    }
                }
            ]
        }
    },
    {
        "step": "create_and_run_stack_recipe",
        "parameters": {
            "input_datasets": [
                "final_calculated_data",
                "aiml_insights_selected",
                "scores_selected"
            ],
            "output_dataset": "stacked_output_dataset",
            "connection": "filesystem_managed",
            "output_format": "CSV",
            "project_key": "CUSTOMER360_ANALYSIS"
        }
    }
]
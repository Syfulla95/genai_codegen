"-- BigQuery SQL Script for Migrating Alteryx Workflow\n\n-- Step 1: Extract Data from Sources\nWITH source_data AS (\n  SELECT \n    so_audat AS so_date,\n    fkdat AS bill_date,\n    werks AS whs,\n    vtweg AS dist_chnl_id,\n    zzfinclass AS fnc_id,\n    bezek AS fnc_desc,\n    soldto_kunnr AS soldto,\n    shipto_kunnr AS shipto,\n    vgbel AS rfrnc_doc_num,\n    DISTINCT_VBELN_Count AS distinct_vbeln_count,\n    BILL_ITM_COUNT AS bill_itm_count,\n    UNIT_LAND_COST AS unit_land_cost,\n    SO_NETWR AS so_netwr,\n    SO_NETPR AS so_netpr,\n    FKLMG AS fklmg,\n    FKIMG AS fkimg,\n    ZTV2 AS ztv2,\n    ZSS2_M2 AS zss2_m2,\n    ZSSH AS zssh,\n    ZSM2 AS zsm2,\n    ZTR2 AS ztr2,\n    ZTR1 AS ztr1,\n    ZSRF AS zsrf,\n    ZSRM AS zsrm,\n    ZH01 AS zh01,\n    ZTHM AS zthm,\n    ZSMO AS zsmo,\n    ZSSM_F_ZTHM AS zssm_f_zthm,\n    ZMT1 AS zmt1,\n    ZVC12M1M3NM AS zvc12m1m3nm,\n    ZMGO AS zmgo,\n    ZMGB AS zmgb,\n    ZMGL AS zmgl\n  FROM `project.dataset.hana_universe`\n  WHERE fkdat BETWEEN '2023-07-01' AND '2023-09-30'\n),\n\n-- Step 2: DateTime Transformations\ndate_transformed AS (\n  SELECT \n    FORMAT_TIMESTAMP('%Y-%m-%d', CURRENT_TIMESTAMP()) AS run_date,\n    FORMAT_DATE('%Y%m%d', DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)) AS start_date,\n    FORMAT_DATE('%Y%m%d', CURRENT_DATE()) AS end_date\n),\n\n-- Step 3: Field Selection and Renaming\nfield_selection AS (\n  SELECT \n    so_date,\n    bill_date,\n    whs,\n    dist_chnl_id,\n    fnc_id,\n    fnc_desc,\n    soldto,\n    shipto,\n    rfrnc_doc_num,\n    unit_land_cost,\n    so_netwr,\n    so_netpr,\n    fklmg,\n    fkimg,\n    ztv2,\n    zss2_m2,\n    zssh,\n    zsm2,\n    ztr2,\n    ztr1,\n    zsrf,\n    zsrm,\n    zh01,\n    zthm,\n    zsmo,\n    zssm_f_zthm,\n    zmt1,\n    zvc12m1m3nm,\n    zmgo,\n    zmgb,\n    zmgl\n  FROM source_data\n),\n\n-- Step 4: Custom Calculations\ncustom_calculations AS (\n  SELECT \n    *,\n    ADDTN_TRANS_FEE_OVRRIDE_ZSRO AS rush_order_fee\n  FROM field_selection\n),\n\n-- Step 5: Multi-Field Formula\nmulti_field_formula AS (\n  SELECT \n    *,\n    COALESCE(so_date, '0') AS so_date,\n    COALESCE(bill_date, '0') AS bill_date,\n    COALESCE(whs, '0') AS whs,\n    COALESCE(dist_chnl_id, '0') AS dist_chnl_id,\n    COALESCE(fnc_id, '0') AS fnc_id,\n    COALESCE(fnc_desc, '0') AS fnc_desc,\n    COALESCE(soldto, '0') AS soldto,\n    COALESCE(shipto, '0') AS shipto,\n    COALESCE(rfrnc_doc_num, '0') AS rfrnc_doc_num\n  FROM custom_calculations\n),\n\n-- Step 6: Data Integration\ndata_integration AS (\n  SELECT \n    a.*,\n    b.dist_chnl_desc\n  FROM multi_field_formula AS a\n  LEFT JOIN `project.dataset.text_input_channel` AS b\n  ON a.dist_chnl_id = b.dist_chnl_id\n),\n\n-- Step 7: Data Filtering\ndata_filtering AS (\n  SELECT \n    *\n  FROM data_integration\n  WHERE fnc_id IS NOT NULL\n),\n\n-- Step 8: Dynamic Rename\ndynamic_rename AS (\n  SELECT \n    *,\n    SUM_Invoice_Lines AS invoice_lines,\n    SUM_Rush_Order_Fee AS rush_order_fee\n  FROM data_filtering\n),\n\n-- Step 9: Output to CSV\nSELECT \n  run_date,\n  so_date,\n  bill_date,\n  whs,\n  dist_chnl_id,\n  dist_chnl_desc,\n  fnc_id,\n  fnc_desc,\n  soldto,\n  shipto,\n  rfrnc_doc_num,\n  invoice_lines,\n  unit_land_cost,\n  landed_cost,\n  so_netwr AS so_netvalue_amt,\n  so_netpr AS so_netprice_amt,\n  invoice_sales,\n  extended_sales,\n  extended_final_price,\n  service_fee,\n  ext_ship_hndl,\n  ext_state_tax,\n  ext_local_tax,\n  base_qty,\n  sell_qty,\n  wgt,\n  vol,\n  vendor_trans_absorb,\n  vendor_drop_ship_absorb,\n  ext_hndl_drop_absorb,\n  vendor_moc_absorb,\n  trans_absorb_amt,\n  trans_charge_amt,\n  restock_fee,\n  restock_fee_man,\n  special_hndl_amt,\n  vendor_hndl_amt,\n  moc_amt,\n  moc_drop_amt,\n  fuel_surcharge,\n  fuel_override_amt,\n  bia_ship_hndl_amt,\n  rush_order_fee,\n  vendor_trans_charge,\n  vendor_drop_ship_fee,\n  markup_vendor_trans,\n  markup_hndl_fee,\n  coe_ship_hndl_amt,\n  vl_srvc_fee,\n  ext_vl_svc_fee,\n  addl_trns_fee,\n  addl_trns_fee_ovrd,\n  dropship_fee,\n  gov_fee,\n  bulk_dist_fee,\n  lum_dist_fee,\n  onsite_rep_fee,\n  hldy_dlvr_fee\nFROM dynamic_rename\n"
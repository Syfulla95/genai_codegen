"# Load necessary libraries\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(DBI)\nlibrary(RPostgres)\nlibrary(logger)\nlibrary(readr)\nlibrary(lubridate)\n\n# Set up logging\nlog_appender(appender_console)\nlog_threshold(INFO)\n\n# Define environment variables for database connection\ndb_host <- Sys.getenv(\"DB_HOST\")\ndb_name <- Sys.getenv(\"DB_NAME\")\ndb_user <- Sys.getenv(\"DB_USER\")\ndb_password <- Sys.getenv(\"DB_PASSWORD\")\n\n# Connect to PostgreSQL database\ncon <- dbConnect(RPostgres::Postgres(), dbname = db_name, host = db_host, user = db_user, password = db_password)\n\n# Load data from CSV files\nlog_info(\"Loading data from CSV files\")\nclaims_df <- read_csv(\"s3://dataeconomy-ohio/ApplicationsData/JNJDataverse/Customer360/claims.csv\")\ndemographics_df <- read_csv(\"s3://dataeconomy-ohio/ApplicationsData/JNJDataverse/Customer360/demographics.csv\")\npolicy_df <- read_csv(\"s3://dataeconomy-ohio/ApplicationsData/JNJDataverse/Customer360/policy.csv\")\nscores_df <- read_csv(\"s3://dataeconomy-ohio/ApplicationsData/JNJDataverse/Customer360/scores.csv\")\naiml_insights_df <- read_csv(\"s3://dataeconomy-ohio/ApplicationsData/JNJDataverse/Customer360/aiml_insights.csv\")\n\n# Transformation: Select relevant fields\nlog_info(\"Selecting relevant fields from datasets\")\ndemographics_selected <- demographics_df %>%\n  select(Customer_ID, Customer_Name, Email, Phone_Number, Address, City, State, Postal_Code, Date_of_Birth, Gender, Marital_Status, Occupation, Income_Level, Customer_Segment)\n\nclaims_selected <- claims_df %>%\n  select(Claim_ID, Policy_ID, Claim_Date, Claim_Type, Claim_Status, Claim_Amount, Claim_Payout)\n\npolicy_selected <- policy_df %>%\n  select(Policy_ID, Customer_ID, Policy_Type, Policy_Status, Policy_Start_Date, Policy_End_Date, Policy_Term, Policy_Premium, Total_Premium_Paid, Renewal_Status, Policy_Addons)\n\n# Transformation: Join datasets\nlog_info(\"Joining datasets\")\ncustomer_policy_df <- inner_join(demographics_selected, policy_selected, by = \"Customer_ID\")\ncustomer_policy_claims_df <- inner_join(customer_policy_df, claims_selected, by = \"Policy_ID\")\n\n# Transformation: Summarize data\nlog_info(\"Summarizing data\")\nsummarized_df <- customer_policy_claims_df %>%\n  group_by(Customer_ID) %>%\n  summarize(\n    Total_Claims = n_distinct(Claim_ID),\n    Policy_Count = n_distinct(Policy_ID),\n    Recent_Claim_Date = max(Claim_Date, na.rm = TRUE),\n    Average_Claim_Amount = mean(Claim_Amount, na.rm = TRUE)\n  )\n\n# Transformation: Join summarized data\nlog_info(\"Joining summarized data with customer policy claims data\")\nfinal_df <- inner_join(customer_policy_claims_df, summarized_df, by = \"Customer_ID\")\n\n# Transformation: Custom calculations\nlog_info(\"Performing custom calculations\")\nfinal_df <- final_df %>%\n  mutate(\n    Age = as.integer(difftime(Sys.Date(), ymd(Date_of_Birth), units = \"weeks\") / 52.25),\n    Claim_To_Premium_Ratio = ifelse(Total_Premium_Paid != 0, Claim_Amount / Total_Premium_Paid, 0),\n    Claims_Per_Policy = ifelse(Policy_Count != 0, Total_Claims / Policy_Count, 0),\n    Retention_Rate = 0.85,\n    Cross_Sell_Opportunities = \"Multi-Policy Discount, Home Coverage Add-on\",\n    Upsell_Potential = \"Premium Vehicle Coverage\"\n  )\n\n# Transformation: Join with scores and AI/ML insights\nlog_info(\"Joining with scores and AI/ML insights\")\nfinal_df <- final_df %>%\n  left_join(scores_df, by = \"Customer_ID\") %>%\n  left_join(aiml_insights_df, by = \"Customer_ID\")\n\n# Output: Write to CSV\nlog_info(\"Writing final output to CSV\")\nwrite_csv(final_df, \"s3://dataeconomy-ohio/ApplicationsData/JNJDataverse/Customer360/Customer_360.csv\")\n\n# Output: Write to PostgreSQL database\nlog_info(\"Writing final output to PostgreSQL database\")\nif (dbExistsTable(con, \"customer_360\")) {\n  dbExecute(con, \"DROP TABLE customer_360\")\n}\ndbWriteTable(con, \"customer_360\", final_df, overwrite = TRUE)\n\n# Close database connection\ndbDisconnect(con)\n\nlog_info(\"ETL process completed successfully\")\n"
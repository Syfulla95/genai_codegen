"# Load necessary libraries\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(DBI)\nlibrary(RPostgres)\nlibrary(logger)\n\n# Set up logging\nlog_appender(appender_console)\nlog_formatter(formatter_glue)\nlog_threshold(INFO)\n\n# Database connection setup\ncon <- tryCatch({\n  dbConnect(RPostgres::Postgres(),\n            dbname = Sys.getenv(\"DB_NAME\"),\n            host = Sys.getenv(\"DB_HOST\"),\n            user = Sys.getenv(\"DB_USER\"),\n            password = Sys.getenv(\"DB_PASSWORD\"))\n}, error = function(e) {\n  log_error(\"Failed to connect to the database: {e$message}\")\n  stop(\"Database connection error\")\n})\n\n# Load data from Hana Prod\nsource_df <- tryCatch({\n  dbGetQuery(con, \"SELECT * FROM hana_billing_universe\")\n}, error = function(e) {\n  log_error(\"Failed to load data from Hana Prod: {e$message}\")\n  stop(\"Data loading error\")\n})\n\n# Load distribution channel data\ndist_channel_df <- tryCatch({\n  dbGetQuery(con, \"SELECT * FROM distribution_channel\")\n}, error = function(e) {\n  log_error(\"Failed to load distribution channel data: {e$message}\")\n  stop(\"Data loading error\")\n})\n\n# Transformation: DateTime Conversion\nsource_df <- source_df %>%\n  mutate(SO_AUDAT = as.Date(SO_AUDAT, format = \"%Y-%m-%d\"),\n         FKDAT = as.Date(FKDAT, format = \"%Y-%m-%d\"))\n\n# Transformation: Field Selection and Renaming\nsource_df <- source_df %>%\n  select(SO_AUDAT, FKDAT, WERKS, VTWEG, ZZFINCLASS, BEZEK, SOLDTO_KUNNR, SHIPTO_KUNNR, VGBEL, VBELN, BILL_ITM_COUNT, UNIT_LAND_COST, SO_NETWR, SO_NETPR, FKLMG, FKIMG, ZTV2, ZSS2_M2, ZSSH, ZSM2, ZTR2, ZTR1, ZSRF, ZSRM, ZH01, ZTHM, ZSMO, ZSSM_F_ZTHM, ZMT1, ZVC12M1M3NM, ZMGO, ZMGB, ZMGL) %>%\n  rename(SO_Date = SO_AUDAT,\n         BILL_DATE = FKDAT,\n         Whs = WERKS,\n         DIST_CHNL_ID = VTWEG,\n         FNC_ID = ZZFINCLASS,\n         FNC_DESC = BEZEK,\n         SOLDTO = SOLDTO_KUNNR,\n         SHIPTO = SHIPTO_KUNNR,\n         RFRNC_DOC_NUM = VGBEL,\n         Invoice_Lines = VBELN,\n         Unit_Land_cost = UNIT_LAND_COST,\n         SO_NetValue_Amt = SO_NETWR,\n         SO_NetPrice_Amt = SO_NETPR)\n\n# Custom Calculations\nsource_df <- source_df %>%\n  mutate(Rush_Order_Fee = ADDTN_TRANS_FEE_OVRRIDE_ZSRO,\n         BIA_SHIP_HNDL_AMT = Sum_Trans_Charge_Amt + Sum_RESTOCK_Fee + Sum_Special_Hndl_Amt + Sum_Vendor_Hndl_Amt + Sum_MOC_Amt + Sum_Fuel_Surcharge,\n         COE_SHIP_HNDL_AMT = Sum_Trans_Charge_Amt + Sum_RESTOCK_Fee + Sum_Special_Hndl_Amt + Sum_Vendor_Hndl_Amt + Sum_MOC_Amt + Sum_Fuel_Surcharge + Rush_Order_Fee + VENDR_TRANS_CHRG_FRT_ZTV1 + MARKUP_VENDOR_TRANS_FEE_AMT_ZMT1)\n\n# Join with distribution channel data\njoined_df <- source_df %>%\n  inner_join(dist_channel_df, by = c(\"DIST_CHNL_ID\" = \"DIST_CHNL\"))\n\n# Filter out null values\nfiltered_df <- joined_df %>%\n  filter(!is.na(FNC_ID) & !is.na(Whs) & !is.na(DIST_CHNL_ID) & !is.na(SOLDTO) & !is.na(SHIPTO))\n\n# Dynamic Field Renaming\nfinal_df <- filtered_df %>%\n  rename_with(tolower)\n\n# Output to CSV\ntryCatch({\n  write_csv(final_df, \"/path/to/target_file.csv\")\n  log_info(\"Data successfully written to CSV\")\n}, error = function(e) {\n  log_error(\"Failed to write data to CSV: {e$message}\")\n  stop(\"CSV writing error\")\n})\n\n# Close database connection\ndbDisconnect(con)\nlog_info(\"Database connection closed\")\n"